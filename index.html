<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Koin | The Next-Gen Prototype</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg,#e0e7ff 0%,#f1f5f9 100%); display:flex; justify-content:center; align-items:center; min-height:100vh; margin:0; }
        .app-container { width:100%; max-width:420px; min-height:100vh; background:white; border-radius:1.5rem; box-shadow:0 25px 50px -12px rgba(0,0,0,0.25); display:flex; flex-direction:column; overflow-y:auto; transition:all 0.5s cubic-bezier(0.4,0,0.2,1); }
        @media(min-width:640px){ .app-container{height:90vh;margin:2rem auto;} }
        .screen { display:none; flex-direction:column; padding:2.5rem 1.5rem; animation:fadeIn 0.5s forwards; position:relative; }
        .screen.active { display:flex; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(20px);} to{opacity:1;transform:translateY(0);} }
        .animate-pop { animation:popIn 0.6s forwards; }
        @keyframes popIn {0%{transform:scale(0.8);opacity:0;}50%{transform:scale(1.1);opacity:1;}100%{transform:scale(1);}}
        .coin-icon { transition: transform 0.3s; font-size:2.5rem; }
        .coin-icon.pop { transform: scale(1.2); }
        .ai-chat-modal, .subscription-modal { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:50; opacity:0; pointer-events:none; transition:opacity 0.3s; }
        .ai-chat-modal.visible, .subscription-modal.visible { opacity:1; pointer-events:auto; }
        .chat-box, .modal-box { background:white; border-radius:1.5rem; width:90%; max-width:400px; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 20px 25px -5px rgba(0,0,0,0.1),0 10px 10px -5px rgba(0,0,0,0.04); }
        .chat-box { height:80vh; }
        .chat-messages { flex-grow:1; overflow-y:auto; padding:1rem; display:flex; flex-direction:column; gap:0.75rem; }
        .chat-message { max-width:85%; padding:0.75rem 1rem; border-radius:1.25rem; line-height:1.4; }
        .chat-message.user { background:#3b82f6; color:white; align-self:flex-end; border-bottom-right-radius:0.25rem; }
        .chat-message.ai { background:#e5e7eb; color:#1f2937; align-self:flex-start; border-bottom-left-radius:0.25rem; }
        #loading-screen { display: flex; align-items: center; justify-content: center; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: white; z-index: 100; transition: opacity 0.5s; }
        .loader { width: 48px; height: 48px; border: 5px solid #E0E7FF; border-bottom-color: #4F46E5; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Card specific styling for the prototype */
        .koin-card {
            width: 100%;
            padding-bottom: 63.1%; /* Aspect ratio 1.585:1 (standard credit card) */
            background: linear-gradient(145deg, #4f46e5, #1e3a8a); /* Deep indigo gradient */
            border-radius: 1.25rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            position: relative;
            color: white;
            transition: transform 0.3s;
            cursor: pointer;
        }
        .koin-card-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
    </style>
</head>
<body>
<div class="app-container">
    <!-- Header -->
    <header class="p-6 pb-0 flex justify-between items-center text-gray-400">
        <button id="back-button" class="hidden transition-transform hover:scale-110">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5"/>
            </svg>
        </button>
        <div class="flex-grow"></div>
        <button id="help-button" class="transition-transform hover:scale-110">Need Help?</button>
    </header>

    <!-- Screen 0: Wallet Home -->
    <div id="screen-0" class="screen active flex-col items-center justify-center text-center space-y-4 pt-8">
        <div class="w-28 h-28 flex items-center justify-center bg-indigo-100 rounded-full animate-pop">
            <span class="text-indigo-600 text-6xl">$</span>
        </div>
        <h2 class="text-5xl font-extrabold text-gray-900" id="wallet-balance">$0.00</h2>
        <button id="subscription-status-button" class="text-lg text-gray-600 underline hover:text-indigo-600 transition-colors">Free Tier</button>
        
        <!-- NEW HISTORY BUTTON -->
        <button id="view-history-button" class="w-full px-6 py-4 bg-gray-200 text-gray-800 font-semibold text-lg rounded-full shadow-lg hover:bg-gray-300 transition-all transform hover:scale-105 mt-6">
            Transaction History
        </button>
        
        <!-- Existing View Card button -->
        <button id="view-card-button" class="w-full px-6 py-4 bg-purple-500 text-white font-semibold text-lg rounded-full shadow-lg hover:bg-purple-600 transition-all transform hover:scale-105">
            View Card
        </button>
        <button id="deposit-button" class="w-full px-6 py-4 bg-indigo-600 text-white font-semibold text-lg rounded-full shadow-lg hover:bg-indigo-700 transition-all transform hover:scale-105">
            Deposit Coins
        </button>
        <button id="go-to-kiosks-button" class="w-full px-6 py-4 bg-gray-200 text-gray-800 font-semibold text-lg rounded-full shadow-lg hover:bg-gray-300 transition-all transform hover:scale-105">
            Find Kiosks
        </button>
    </div>

    <!-- Screen 1: Find Kiosks -->
    <div id="screen-1" class="screen flex-col items-center justify-center text-center space-y-10">
        <h1 class="text-4xl font-extrabold text-gray-900">Find Kiosks</h1>
        <p class="text-lg text-gray-600">Find a Koin Kiosk nearby</p>
        <iframe src="https://storage.googleapis.com/maps-solutions-2fxrm56wcn/locator-plus/kbwo/locator-plus.html" class="rounded-2xl shadow-md border-2 border-indigo-200 w-full h-80" style="border:0;"></iframe>
        <button id="scan-button" class="w-full px-6 py-4 bg-indigo-600 text-white font-semibold text-lg rounded-full shadow-lg hover:bg-indigo-700 transition-all transform hover:scale-105">
            Scan Kiosk QR Code
        </button>
    </div>

    <!-- Screen 2: Coin Counting -->
    <div id="screen-2" class="screen flex-col items-center justify-center text-center space-y-8">
        <div id="status-display-container" class="flex flex-col items-center space-y-4">
            <div id="counting-animation-container" class="relative w-40 h-40 flex items-center justify-center">
                <span id="coin-icon" class="coin-icon absolute">$</span>
            </div>
            <h2 id="status-message" class="text-2xl font-semibold text-gray-700 mt-4">Connecting to Kiosk... </h2>
        </div>
        <div class="text-6xl font-extrabold text-gray-900" id="gross-display">$0.00</div>
        <p class="text-sm text-gray-500 mt-2">Gross Deposit</p>
        <div class="w-full space-y-4 bg-gray-50 p-6 rounded-2xl shadow-inner border border-gray-200">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Transaction Breakdown</h3>
            <div class="flex justify-between items-center text-sm text-gray-600">
                <span>Gross Deposit:</span><span id="gross-deposit-final" class="font-medium text-gray-800">$0.00</span>
            </div>
            <div id="rare-coin-bonus-row" class="flex justify-between items-center text-sm text-green-500 hidden">
                <span>Rare Coin Bonus:</span><span id="rare-coin-bonus-display" class="font-medium">+$0.00</span>
            </div>
            <div class="flex justify-between items-center text-sm text-red-500">
                <span>Service Fee (<span id="fee-percentage">5%</span>):</span><span id="service-fee-display" class="font-medium">-$0.00</span>
            </div>
            <div class="flex justify-between items-center text-xl font-bold text-gray-900 pt-4 border-t border-gray-200">
                <span>Net Credit:</span><span id="net-credit-display" class="text-indigo-600">$0.00</span>
            </div>
        </div>
        <button id="transfer-button" class="w-full px-6 py-4 bg-indigo-600 text-white font-semibold text-lg rounded-full shadow-lg hover:bg-indigo-700 transition-all transform hover:scale-105 hidden">
            Transfer Credit to Wallet
        </button>
    </div>

    <!-- Screen 3: Transfer Complete -->
    <div id="screen-3" class="screen flex-col items-center justify-center text-center space-y-8">
        <div id="checkmark-container" class="w-24 h-24 flex items-center justify-center bg-green-500 rounded-full animate-pop">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-16 h-16 text-white">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5"/>
            </svg>
        </div>
        <h2 class="text-3xl font-bold text-gray-900">Transfer Complete!Â </h2>
        <div class="w-full bg-gray-50 rounded-2xl p-6 shadow-sm border border-gray-200 text-left space-y-4">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Transaction Summary </h3>
            <div class="space-y-3 text-sm">
                <div class="flex justify-between"><span class="text-gray-500">Gross Deposit:</span><span id="receipt-gross" class="font-medium text-gray-800">$0.00</span></div>
                <div class="flex justify-between"><span class="text-gray-500">Service Fee:</span><span id="receipt-fee" class="font-medium text-red-500">-$0.00</span></div>
                <div class="flex justify-between items-center text-base font-bold text-gray-900 pt-2 border-t border-gray-200"><span class="text-gray-600">Net Credit:</span><span id="receipt-net-credit" class="text-indigo-600">$0.00</span></div>
                <div class="flex justify-between items-center pt-2"><span class="text-gray-500">Transaction ID:</span><span id="receipt-tx-id" class="font-mono text-gray-800">#</span></div>
                <div class="flex justify-between"><span class="text-gray-500">Timestamp:</span><span id="receipt-timestamp" class="font-medium text-gray-800"></span></div>
            </div>
        </div>
        <button id="view-wallet-button" class="w-full px-6 py-4 bg-indigo-600 text-white font-semibold text-lg rounded-full shadow-lg hover:bg-indigo-700 transition-all transform hover:scale-105">
            View Wallet
        </button>
    </div>
    
    <!-- Screen 4: View Card -->
    <div id="screen-4" class="screen flex-col items-center justify-center text-center space-y-8">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-6">Your Digital Card</h1>
        
        <div class="koin-card hover:scale-[1.02] active:scale-[0.98]">
            <div class="koin-card-content">
                <!-- Top Section -->
                <div class="flex justify-between items-start">
                    <span class="text-3xl font-black tracking-widest leading-none">KOIN</span>
                    <!-- Chip SVG -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-yellow-300">
                        <rect x="2" y="7" width="20" height="10" rx="2" ry="2"></rect>
                        <line x1="8" y1="7" x2="8" y2="17"></line>
                        <line x1="16" y1="7" x2="16" y2="17"></line>
                        <line x1="12" y1="7" x2="12" y2="17"></line>
                        <line x1="2" y1="12" x2="22" y2="12"></line>
                    </svg>
                </div>

                <!-- Middle Section - Card Number -->
                <div class="text-3xl font-mono font-semibold tracking-wider drop-shadow-md">
                    <span class="text-lg font-light text-gray-300 mr-2">â¢â¢â¢â¢</span> 4242 
                    <span class="text-lg font-light text-gray-300 mx-1">â¢â¢â¢â¢</span> â¢â¢â¢â¢ 
                    <span class="text-lg font-light text-gray-300 ml-1">â¢â¢â¢â¢</span> 0001
                </div>

                <!-- Bottom Section - Name and Expiry -->
                <div class="flex justify-between items-center text-sm font-medium">
                    <div class="flex flex-col text-left">
                        <span class="text-xs text-gray-300 uppercase">Card Holder</span>
                        <span class="text-lg tracking-wider">JANE DOE</span>
                    </div>
                    <div class="flex flex-col text-right">
                        <span class="text-xs text-gray-300 uppercase">Expires</span>
                        <span class="text-lg">12/28</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="w-full p-4 bg-gray-50 rounded-xl shadow-inner border border-gray-200 text-left space-y-3">
             <div class="text-sm text-gray-600 flex justify-between"><span>CVV:</span> <span class="font-mono text-gray-900 font-semibold">123</span></div>
             <div class="text-sm text-gray-600 flex justify-between"><span>Status:</span> <span class="font-semibold text-green-600">Active</span></div>
             <div class="text-sm text-gray-600 flex justify-between"><span>Card Type:</span> <span class="font-semibold text-gray-900">Virtual Prepaid</span></div>
        </div>
        
        <button onclick="KoinApp.showMessage('Card successfully copied to clipboard! (Prototype functionality)')" class="w-full px-6 py-4 bg-indigo-600 text-white font-semibold text-lg rounded-full shadow-lg hover:bg-indigo-700 transition-all transform hover:scale-105">
            Copy Card Details
        </button>
    </div>

    <!-- Screen 5: Transaction History (NEW) -->
    <div id="screen-5" class="screen flex-col space-y-6">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2">Transaction History</h1>
        <div id="history-list" class="flex flex-col space-y-3 overflow-y-auto flex-grow h-full max-h-[70vh]">
            <p id="no-history-message" class="text-center text-gray-500 italic mt-8">No coin deposits recorded yet. Time to get counting!</p>
        </div>
    </div>
</div>

<!-- AI Chat Modal -->
<div id="ai-chat-modal" class="ai-chat-modal">
    <div class="chat-box">
        <div class="flex justify-between items-center p-4 border-b border-gray-200">
            <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                <span class="text-3xl">$</span>
                AI Support
            </h3>
            <button id="close-chat-button" class="text-gray-500 hover:text-gray-800 transition-colors">â</button>
        </div>
        <div id="chat-messages" class="chat-messages">
            <div class="chat-message ai">Hi! I'm your Koin AI assistant. Ask me about **deposits**, **kiosks**, **fees**, or **premium** to get a quick answer.</div>
        </div>
        <div class="p-4 border-t border-gray-200 flex items-center space-x-2">
            <input id="chat-input" type="text" placeholder="Type your message..." class="flex-grow rounded-full border border-gray-300 px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            <button id="chat-send-button" class="bg-indigo-600 text-white p-2 rounded-full hover:bg-indigo-700">â¡</button>
        </div>
    </div>
</div>

<!-- Subscription Modal -->
<div id="subscription-modal" class="subscription-modal">
    <div class="modal-box p-6 space-y-6">
        <div class="flex justify-between items-center">
            <h3 class="text-2xl font-bold text-gray-900">Choose your plan</h3>
            <button id="close-subscription-modal-button" class="text-gray-500 hover:text-gray-800 transition-colors">â</button>
        </div>
        <div class="space-y-4">
            <div class="p-4 rounded-xl border-2 border-indigo-200 bg-indigo-50 text-center space-y-2">
                <h4 class="text-xl font-bold text-indigo-800">Premium Tier</h4>
                <p class="text-lg text-indigo-600 font-semibold">$1.00 / month</p>
                <p class="text-sm text-gray-600">Reduced 2% fee on all deposits and unlocks rare coin detection feature.</p>
                <button id="premium-tier-button" class="mt-2 w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-full hover:bg-indigo-700 transition-colors">Select Premium</button>
            </div>
            <div class="p-4 rounded-xl border-2 border-gray-200 bg-gray-50 text-center space-y-2">
                <h4 class="text-xl font-bold text-gray-800">Free Tier</h4>
                <p class="text-lg text-gray-600 font-semibold">$0.00 / month</p>
                <p class="text-sm text-gray-500">Standard 5% fee on all deposits. Basic features included.</p>
                <button id="free-tier-button" class="mt-2 w-full px-6 py-3 bg-gray-200 text-gray-800 font-semibold rounded-full hover:bg-gray-300 transition-colors">Select Free</button>
            </div>
        </div>
    </div>
</div>

<script>
    const KoinApp = (() => {
        // --- State and Element References ---
        const appState = {
            walletBalance: 0,
            history: [], // ADDED: Array to store transaction history
            subscriptionStatus: 'Free Tier',
            lastPaymentDate: null,
            currentScreen: 0,
            grossDeposit: 0,
            serviceFee: 0,
            netCredit: 0,
            transactionId: '',
            transactionTimestamp: null,
            isCounting: false,
            rareCoinFound: null,
            isChatOpen: false,
            isAiTyping: false,
            serviceFeeRate: 0.05 // Initial Fee Rate
        };
        let coinCountingIntervalId = null;

        const elements = {
            screens: document.querySelectorAll('.screen'),
            walletBalanceDisplay: document.getElementById('wallet-balance'),
            subscriptionStatusButton: document.getElementById('subscription-status-button'),
            depositButton: document.getElementById('deposit-button'),
            goToKiosksButton: document.getElementById('go-to-kiosks-button'),
            scanButton: document.getElementById('scan-button'),
            transferButton: document.getElementById('transfer-button'),
            viewWalletButton: document.getElementById('view-wallet-button'),
            backButton: document.getElementById('back-button'),
            helpButton: document.getElementById('help-button'),
            grossDisplay: document.getElementById('gross-display'),
            statusMessage: document.getElementById('status-message'),
            coinIcon: document.getElementById('coin-icon'),
            grossDepositFinal: document.getElementById('gross-deposit-final'),
            feePercentage: document.getElementById('fee-percentage'),
            serviceFeeDisplay: document.getElementById('service-fee-display'),
            netCreditDisplay: document.getElementById('net-credit-display'),
            receiptGross: document.getElementById('receipt-gross'),
            receiptFee: document.getElementById('receipt-fee'),
            receiptNetCredit: document.getElementById('receipt-net-credit'),
            receiptTxId: document.getElementById('receipt-tx-id'),
            receiptTimestamp: document.getElementById('receipt-timestamp'),
            aiChatModal: document.getElementById('ai-chat-modal'),
            closeChatButton: document.getElementById('close-chat-button'),
            chatInput: document.getElementById('chat-input'),
            chatSendButton: document.getElementById('chat-send-button'),
            chatMessages: document.getElementById('chat-messages'),
            statusDisplayContainer: document.getElementById('status-display-container'),
            aiTypingIndicator: document.getElementById('ai-typing-indicator'),
            subscriptionModal: document.getElementById('subscription-modal'),
            closeSubscriptionModalButton: document.getElementById('close-subscription-modal-button'),
            freeTierButton: document.getElementById('free-tier-button'),
            premiumTierButton: document.getElementById('premium-tier-button'),
            rareCoinBonusDisplay: document.getElementById('rare-coin-bonus-display'),
            rareCoinBonusRow: document.getElementById('rare-coin-bonus-row'),
            viewCardButton: document.getElementById('view-card-button'),
            // ADDED: History elements
            viewHistoryButton: document.getElementById('view-history-button'),
            historyList: document.getElementById('history-list'),
            noHistoryMessage: document.getElementById('no-history-message')
        };
        
        // Hardcoded list of rare coins and their values for the app demo
        const rareCoins = [
            { coinType: 'pennies', value: 0.01, rareValue: 50.00, name: '1909-S VDB Lincoln Cent' },
            { coinType: 'nickels', value: 0.05, rareValue: 150.00, name: '1937-D Three-Legged Buffalo Nickel' },
            { coinType: 'dimes', value: 0.10, rareValue: 100.00, name: '1916-D Mercury Dime' },
            { coinType: 'quarters', value: 0.25, rareValue: 200.00, name: '1932-S Washington Quarter' },
        ];
        
        // --- Core App Functions ---
        const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        const formatCurrency = (amount) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
        
        // Expose showMessage globally for inline HTML button
        window.KoinApp = { showMessage: showMessage };

        function showMessage(message, type = 'info') {
            const modal = document.createElement('div');
            modal.className = `fixed inset-0 flex items-center justify-center z-[100] p-4 bg-black bg-opacity-40 transition-opacity duration-300`;
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl p-6 text-center max-w-sm w-full animate-pop">
                    <p class="font-medium text-lg mb-4 text-gray-800">${message}</p>
                    <button class="bg-indigo-600 text-white px-6 py-2 rounded-full font-semibold hover:bg-indigo-700 transition-colors" onclick="this.parentNode.parentNode.remove()">OK</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        const getCoinEmoji = (coinType) => {
            switch (coinType) {
                case 'quarters': return 'ðª';
                case 'dimes': return 'ð²';
                case 'nickels': return 'â¨';
                case 'pennies': return 'ðµ';
                default: return 'ð°';
            }
        };

        const switchScreen = (screenNumber) => {
            elements.screens.forEach(screen => screen.classList.remove('active'));
            document.getElementById(`screen-${screenNumber}`).classList.add('active');
            appState.currentScreen = screenNumber;
            // Back button visible for all screens except home (0)
            elements.backButton.classList.toggle('hidden', screenNumber === 0);Â 
        };

        const updateWalletUI = () => {
            elements.walletBalanceDisplay.textContent = formatCurrency(appState.walletBalance);
            elements.subscriptionStatusButton.textContent = appState.subscriptionStatus;
            
            const freeFee = 0.05; // 5% fee for Free Tier
            const premiumFee = 0.02; // 2% fee for Premium Tier
            
            if (appState.subscriptionStatus === 'Free Tier') {
                appState.serviceFeeRate = freeFee;
                elements.feePercentage.textContent = '5%';
                elements.premiumTierButton.textContent = 'Select Premium';
                elements.premiumTierButton.disabled = false;
                elements.freeTierButton.textContent = 'Current Plan';
                elements.freeTierButton.disabled = true;
            } else if (appState.subscriptionStatus === 'Premium Tier') {
                appState.serviceFeeRate = premiumFee;
                elements.feePercentage.textContent = '2%';
                elements.premiumTierButton.textContent = 'Current Plan';
                elements.premiumTierButton.disabled = true;
                elements.freeTierButton.textContent = 'Downgrade to Free';
                elements.freeTierButton.disabled = false;
            }
        };

        const updateDisplay = () => {
            elements.grossDisplay.textContent = formatCurrency(appState.grossDeposit);
            elements.grossDepositFinal.textContent = formatCurrency(appState.grossDeposit);
            elements.serviceFeeDisplay.textContent = `-${formatCurrency(appState.serviceFee)}`;
            elements.netCreditDisplay.textContent = formatCurrency(appState.netCredit);
            
            if (appState.rareCoinFound) {
                elements.rareCoinBonusDisplay.textContent = `+${formatCurrency(appState.rareCoinFound.rareValue)}`;
                elements.rareCoinBonusRow.classList.remove('hidden');
            } else {
                elements.rareCoinBonusRow.classList.add('hidden');
            }
        };

        const stopCoinCounting = () => {
            if (coinCountingIntervalId) {
                clearInterval(coinCountingIntervalId);
                coinCountingIntervalId = null;
            }
        };

        const simulateCoinCounting = () => {
            stopCoinCounting();
            
            appState.isCounting = true;
            appState.rareCoinFound = null; // Reset rare coin status
            elements.transferButton.classList.add('hidden');
            elements.statusDisplayContainer.classList.remove('hidden');
            elements.statusMessage.textContent = "Start inserting coins.";

            const coinValues = {
                'quarters': 0.25, 'dimes': 0.10, 'nickels': 0.05, 'pennies': 0.01
            };
            const coinTypes = Object.keys(coinValues);
            const coinMix = {};
            coinTypes.forEach(type => {
                coinMix[type] = getRandomInt(10, 30);
            });

            const allCoins = Object.entries(coinMix).flatMap(([type, count]) => Array(count).fill(type));
            const shuffledCoins = allCoins.sort(() => Math.random() - 0.5);

            let coinIndex = 0;

            coinCountingIntervalId = setInterval(() => {
                if (coinIndex >= shuffledCoins.length) {
                    stopCoinCounting();
                    appState.isCounting = false;
                    elements.statusMessage.textContent = "Transaction Ready!";
                    elements.transferButton.classList.remove('hidden');
                    return;
                }

                const coinType = shuffledCoins[coinIndex];
                let coinValue = coinValues[coinType];
                
                // Check for rare coin if premium subscription is active
                if (appState.subscriptionStatus === 'Premium Tier') {
                    const isRare = Math.random() < 0.05;Â 
                    if (isRare) {
                        const foundRareCoin = rareCoins.find(c => c.coinType === coinType);
                        if (foundRareCoin) {
                            appState.rareCoinFound = foundRareCoin;
                            coinValue += foundRareCoin.rareValue;
                            showMessage(`Congratulations! You found a rare ${foundRareCoin.name} worth ${formatCurrency(foundRareCoin.rareValue)}!`, 'success');
                        }
                    }
                }

                appState.grossDeposit += coinValue;
                appState.grossDeposit = parseFloat(appState.grossDeposit.toFixed(2));
                let bonus = appState.rareCoinFound ? appState.rareCoinFound.rareValue : 0;
                let feeBase = appState.grossDeposit - bonus;
                
                // Fee is only applied to the coin deposit, not the rare coin bonus
                appState.serviceFee = parseFloat((feeBase * appState.serviceFeeRate).toFixed(2));
                appState.netCredit = parseFloat((appState.grossDeposit + (appState.rareCoinFound ? appState.rareCoinFound.rareValue : 0) - appState.serviceFee).toFixed(2));
                
                elements.coinIcon.textContent = getCoinEmoji(coinType);
                elements.coinIcon.classList.add('pop');
                setTimeout(() => elements.coinIcon.classList.remove('pop'), 200);

                updateDisplay();
                coinIndex++;
            }, 100);
        };

        const resetTransaction = () => {
            appState.grossDeposit = 0;
            appState.serviceFee = 0;
            appState.netCredit = 0;
            appState.rareCoinFound = null;
            updateDisplay();
        };

        const handlePremiumPayment = () => {
            if (appState.walletBalance >= 1) {
                appState.walletBalance = parseFloat((appState.walletBalance - 1).toFixed(2));
                
                // ADDED: Record Subscription Payment Transaction
                const premiumTx = {
                    id: Math.random().toString(36).substring(2, 11).toUpperCase(),
                    timestamp: new Date().toISOString(),
                    gross: -1.00, // Cost of subscription
                    fee: 0,
                    net: -1.00,
                    type: 'Premium Subscription',
                    subscription: 'Premium Tier',
                    bonus: 0,
                    rareCoinName: null
                };
                appState.history.unshift(premiumTx);

                appState.subscriptionStatus = 'Premium Tier';
                elements.subscriptionModal.classList.remove('visible');
                updateWalletUI();
                showMessage("Success! You're now a Premium member. Enjoy the 5% rare coin chance and reduced fees!", 'success');
            } else {
                showMessage("Insufficient funds to upgrade to Premium. You need at least $1.00.", 'error');
            }
        };

        // ADDED: Function to render the history list
        const renderHistory = () => {
            elements.historyList.innerHTML = '';
            
            if (appState.history.length === 0) {
                elements.historyList.innerHTML = '<p id="no-history-message" class="text-center text-gray-500 italic mt-8">No coin deposits recorded yet. Time to get counting!</p>';
                return;
            }

            appState.history.forEach(tx => {
                const date = new Date(tx.timestamp).toLocaleString();
                const isBonus = tx.bonus > 0;
                const netColor = tx.net >= 0 ? 'text-green-600' : 'text-red-600';
                const txType = tx.type === 'Coin Deposit' ? 'Coin Deposit' : 'Subscription';

                const txElement = document.createElement('div');
                txElement.className = 'flex justify-between items-center p-4 rounded-xl bg-white shadow-sm border border-gray-100 transition-shadow hover:shadow-md';
                txElement.innerHTML = `
                    <div class="flex flex-col text-left">
                        <span class="font-semibold text-gray-900 text-base">${tx.type}</span>
                        <span class="text-xs text-gray-500">${date}</span>
                        ${isBonus ? `<span class="text-xs text-green-500 font-medium">${tx.rareCoinName} Bonus</span>` : ''}
                        <span class="text-xs text-gray-400 mt-1">ID: ${tx.id}</span>
                    </div>
                    <div class="flex flex-col text-right">
                        <span class="text-lg font-bold ${netColor}">${formatCurrency(tx.net)}</span>
                        <span class="text-xs text-gray-500">Net Value</span>
                        ${tx.fee > 0 ? `<span class="text-xs text-red-500 mt-1">Fee: ${formatCurrency(tx.fee)}</span>` : ''}
                    </div>
                `;
                elements.historyList.appendChild(txElement);
            });
        };

        // --- AI Chat Logic ---
        const addMessageToChat = (message, sender) => {
            const messageDiv = document.createElement('div');
            messageDiv.textContent = message;
            messageDiv.classList.add('chat-message', sender);
            elements.chatMessages.appendChild(messageDiv);
            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
        };

        const handleChatMessage = (userMessage) => {
            addMessageToChat(userMessage, 'user');
            const lowerCaseMessage = userMessage.toLowerCase();
            let aiResponse = "I'm sorry, I don't understand that. Please ask about **deposits**, **kiosks**, **fees**, or **premium**.";
            
            if (lowerCaseMessage.includes('deposit')) {
                aiResponse = "To make a deposit, navigate to the Find Kiosks screen and use the 'Scan Kiosk QR Code' button to begin the coin counting process.";
            } else if (lowerCaseMessage.includes('kiosk')) {
                aiResponse = "You can find the nearest Koin Kiosk on the map. Simply head to the 'Find Kiosks' screen from the home page.";
            } else if (lowerCaseMessage.includes('fee')) {
                aiResponse = `Koin charges a service fee on all deposits. It is ${appState.serviceFeeRate * 100}% for your current ${appState.subscriptionStatus}.`;
            } else if (lowerCaseMessage.includes('premium')) {
                aiResponse = "The Premium Tier subscription costs $1.00 per month. It reduces your service fee to 2% and unlocks the rare coin detection feature, which has a 5% chance of finding a bonus coin during a deposit!";
            }
            
            setTimeout(() => {
                addMessageToChat(aiResponse, 'ai');
            }, 500);
        };

        // --- Event Listeners ---
        const setupEventListeners = () => {
            // Screen switching
            elements.depositButton.addEventListener('click', () => switchScreen(1));
            elements.goToKiosksButton.addEventListener('click', () => switchScreen(1));
            elements.viewCardButton.addEventListener('click', () => switchScreen(4));
            
            // ADDED: History Button Listener
            elements.viewHistoryButton.addEventListener('click', () => {
                renderHistory();
                switchScreen(5);
            });
            
            elements.scanButton.addEventListener('click', () => {
                resetTransaction();
                switchScreen(2);
                setTimeout(() => {
                    elements.statusMessage.textContent = "Start inserting coins.";
                    simulateCoinCounting();
                }, 2000);
            });

            elements.transferButton.addEventListener('click', () => {
                stopCoinCounting();
                appState.walletBalance += appState.netCredit;
                appState.walletBalance = parseFloat(appState.walletBalance.toFixed(2));
                appState.transactionId = Math.random().toString(36).substring(2, 11).toUpperCase();
                appState.transactionTimestamp = new Date();
                
                // ADDED: Record Coin Deposit Transaction
                const newTransaction = {
                    id: appState.transactionId,
                    timestamp: appState.transactionTimestamp.toISOString(),
                    gross: appState.grossDeposit,
                    fee: appState.serviceFee,
                    net: appState.netCredit,
                    type: 'Coin Deposit',
                    subscription: appState.subscriptionStatus,
                    bonus: appState.rareCoinFound ? appState.rareCoinFound.rareValue : 0,
                    rareCoinName: appState.rareCoinFound ? appState.rareCoinFound.name : null
                };
                appState.history.unshift(newTransaction);

                elements.receiptGross.textContent = formatCurrency(appState.grossDeposit);
                elements.receiptFee.textContent = `-${formatCurrency(appState.serviceFee)}`;
                elements.receiptNetCredit.textContent = formatCurrency(appState.netCredit);
                elements.receiptTxId.textContent = `#${appState.transactionId}`;
                elements.receiptTimestamp.textContent = appState.transactionTimestamp.toLocaleString();
                updateWalletUI(); // Update final balance display
                switchScreen(3);
            });

            elements.viewWalletButton.addEventListener('click', () => {
                switchScreen(0);
                resetTransaction();
            });

            elements.backButton.addEventListener('click', () => {
                if (appState.currentScreen === 5 || appState.currentScreen === 4 || appState.currentScreen === 1) {
                    switchScreen(0);
                } else if (appState.currentScreen === 2) {
                    stopCoinCounting();
                    resetTransaction();
                    switchScreen(1);
                } else if (appState.currentScreen === 3) {
                    // From receipt back to home
                    switchScreen(0); 
                }
            });

            // AI Chat listeners
            elements.helpButton.addEventListener('click', () => elements.aiChatModal.classList.add('visible'));
            elements.closeChatButton.addEventListener('click', () => elements.aiChatModal.classList.remove('visible'));

            const sendChatMessage = () => {
                const message = elements.chatInput.value.trim();
                if (message) {
                    handleChatMessage(message);
                    elements.chatInput.value = '';
                }
            };

            elements.chatSendButton.addEventListener('click', sendChatMessage);
            elements.chatInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    sendChatMessage();
                }
            });

            // Subscription listeners
            elements.subscriptionStatusButton.addEventListener('click', () => elements.subscriptionModal.classList.add('visible'));
            elements.closeSubscriptionModalButton.addEventListener('click', () => elements.subscriptionModal.classList.remove('visible'));

            elements.freeTierButton.addEventListener('click', () => {
                if (appState.subscriptionStatus === 'Premium Tier') {
                    // ADDED: Record Subscription Downgrade Transaction
                    const freeTx = {
                        id: Math.random().toString(36).substring(2, 11).toUpperCase(),
                        timestamp: new Date().toISOString(),
                        gross: 0,
                        fee: 0,
                        net: 0,
                        type: 'Subscription Downgrade',
                        subscription: 'Free Tier',
                        bonus: 0,
                        rareCoinName: null
                    };
                    appState.history.unshift(freeTx);
                    
                    appState.subscriptionStatus = 'Free Tier';
                    elements.subscriptionModal.classList.remove('visible');
                    updateWalletUI();
                    showMessage("Subscription updated to Free Tier (5% fee).", 'success');
                }
            });
            elements.premiumTierButton.addEventListener('click', handlePremiumPayment);
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            updateWalletUI(); // Initialize wallet display and fee rate on load
            switchScreen(0); // Start on the wallet home screen
        });
        
        return { showMessage };
    })();
</script>
</body>
</html>
